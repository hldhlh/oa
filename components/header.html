<!-- 页面头部组件 -->
<header class="bg-white shadow-sm border-b border-gray-200 w-full">
    <div class="flex items-center justify-between px-6 py-4 w-full">
        <!-- 左侧：Logo和面包屑导航 -->
        <div class="flex items-center">
            <!-- Logo区域 -->
            <div class="flex items-center mr-8">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-xl font-bold">火</span>
                </div>
                <div class="ml-3">
                    <h1 class="text-lg font-bold text-gray-900">火锅店OA</h1>
                    <p class="text-xs text-gray-500">管理系统</p>
                </div>
            </div>

            <!-- 面包屑导航 -->
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2" id="breadcrumb">
                    <li>
                        <a href="dashboard.html" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                            </svg>
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="ml-2 text-sm font-medium text-gray-900" id="current-page-title">仪表板</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <!-- 中间：搜索框 -->
        <div class="flex-1 max-w-lg mx-8">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text" 
                       id="global-search" 
                       class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-red-500 focus:border-red-500 sm:text-sm" 
                       placeholder="搜索文档、配方、员工...">
                
                <!-- 搜索结果下拉框 -->
                <div id="search-results" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                    <!-- 搜索结果将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 右侧：通知和用户菜单 -->
        <div class="flex items-center space-x-4">
            <!-- 通知按钮 -->
            <button class="relative p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM10.5 3.75a6 6 0 0 1 6 6v2.25l2.25 2.25v2.25H2.25V14.25L4.5 12V9.75a6 6 0 0 1 6-6z"></path>
                </svg>
                <!-- 通知数量徽章 -->
                <span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-400 ring-2 ring-white"></span>
            </button>

            <!-- 快速操作按钮 -->
            <div class="relative">
                <button id="quick-actions-btn" class="p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </button>
                
                <!-- 快速操作下拉菜单 -->
                <div id="quick-actions-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                    <a href="pages/formulas.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <div class="flex items-center">
                            <span class="mr-3">🍲</span>
                            新建配方
                        </div>
                    </a>
                    <a href="pages/documents.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <div class="flex items-center">
                            <span class="mr-3">📄</span>
                            上传文档
                        </div>
                    </a>
                    <a href="pages/staff.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <div class="flex items-center">
                            <span class="mr-3">👥</span>
                            添加员工
                        </div>
                    </a>
                    <a href="pages/stores.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <div class="flex items-center">
                            <span class="mr-3">🏪</span>
                            新建门店
                        </div>
                    </a>
                </div>
            </div>

            <!-- 用户菜单 -->
            <div class="relative">
                <button id="user-menu-btn" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <span class="text-gray-600 text-sm font-medium" id="header-user-avatar">U</span>
                    </div>
                    <svg class="ml-2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <!-- 用户下拉菜单 -->
                <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">个人资料</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">账户设置</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">帮助中心</a>
                    <div class="border-t border-gray-100"></div>
                    <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">退出登录</button>
                </div>
            </div>

            <!-- 全屏按钮 -->
            <button id="fullscreen-btn" class="p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                </svg>
            </button>
        </div>
    </div>
</header>

<script>
// 头部组件初始化
document.addEventListener('DOMContentLoaded', function() {
    initHeader();
});

function initHeader() {
    updatePageTitle();
    updateUserAvatar();
    setupSearchFunctionality();
    setupDropdownMenus();
    setupFullscreenToggle();
}

// 更新页面标题
function updatePageTitle() {
    const path = window.location.pathname;
    const titleElement = document.getElementById('current-page-title');
    
    if (!titleElement) return;
    
    const pageTitles = {
        'dashboard': '仪表板',
        'stores': '门店管理',
        'staff': '员工管理',
        'formulas': '配方管理',
        'documents': '文档中心',
        'operations': '运营管理',
        'reports': '报表分析',
        'admin': '系统管理'
    };
    
    for (const [key, title] of Object.entries(pageTitles)) {
        if (path.includes(key)) {
            titleElement.textContent = title;
            break;
        }
    }
}

// 更新用户头像
function updateUserAvatar() {
    if (typeof authManager !== 'undefined' && authManager) {
        const userInfo = authManager.getCurrentUser();
        if (userInfo.user) {
            const avatar = document.getElementById('header-user-avatar');
            if (avatar) {
                const name = userInfo.profile?.name || userInfo.user.email;
                avatar.textContent = name.charAt(0).toUpperCase();
            }
        }
    }
}

// 设置搜索功能
function setupSearchFunctionality() {
    const searchInput = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results');
    
    if (!searchInput || !searchResults) return;
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            await performSearch(query);
        }, 300);
    });
    
    // 点击外部关闭搜索结果
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });
}

// 执行搜索
async function performSearch(query) {
    const searchResults = document.getElementById('search-results');
    if (!searchResults) return;
    
    try {
        // 显示加载状态
        searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">搜索中...</div>';
        searchResults.classList.remove('hidden');
        
        // 执行搜索（这里需要实际的搜索逻辑）
        if (typeof getDatabase === 'function') {
            const db = getDatabase();
            const results = await db.globalSearch(query);
            displaySearchResults(results);
        } else {
            // 模拟搜索结果
            setTimeout(() => {
                const mockResults = {
                    documents: [
                        { id: 1, title: '员工手册', type: 'document' },
                        { id: 2, title: '安全操作规程', type: 'document' }
                    ],
                    formulas: [
                        { id: 1, name: '经典麻辣锅底', type: 'formula' }
                    ]
                };
                displaySearchResults(mockResults);
            }, 500);
        }
    } catch (error) {
        console.error('搜索失败:', error);
        searchResults.innerHTML = '<div class="px-4 py-2 text-sm text-red-500">搜索失败</div>';
    }
}

// 显示搜索结果
function displaySearchResults(results) {
    const searchResults = document.getElementById('search-results');
    if (!searchResults) return;
    
    let html = '';
    let hasResults = false;
    
    // 文档结果
    if (results.documents && results.documents.length > 0) {
        html += '<div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">文档</div>';
        results.documents.forEach(doc => {
            html += `
                <a href="pages/documents.html?id=${doc.id}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <div class="flex items-center">
                        <span class="mr-3">📄</span>
                        ${doc.title}
                    </div>
                </a>
            `;
        });
        hasResults = true;
    }
    
    // 配方结果
    if (results.formulas && results.formulas.length > 0) {
        if (hasResults) html += '<div class="border-t border-gray-100"></div>';
        html += '<div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">配方</div>';
        results.formulas.forEach(formula => {
            html += `
                <a href="pages/formulas.html?id=${formula.id}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <div class="flex items-center">
                        <span class="mr-3">🍲</span>
                        ${formula.name}
                    </div>
                </a>
            `;
        });
        hasResults = true;
    }
    
    if (!hasResults) {
        html = '<div class="px-4 py-2 text-sm text-gray-500">未找到相关结果</div>';
    }
    
    searchResults.innerHTML = html;
    searchResults.classList.remove('hidden');
}

// 设置下拉菜单
function setupDropdownMenus() {
    // 快速操作菜单
    const quickActionsBtn = document.getElementById('quick-actions-btn');
    const quickActionsMenu = document.getElementById('quick-actions-menu');
    
    if (quickActionsBtn && quickActionsMenu) {
        quickActionsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            quickActionsMenu.classList.toggle('hidden');
            // 关闭其他菜单
            const userMenu = document.getElementById('user-menu');
            if (userMenu) userMenu.classList.add('hidden');
        });
    }
    
    // 用户菜单
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userMenu = document.getElementById('user-menu');
    
    if (userMenuBtn && userMenu) {
        userMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('hidden');
            // 关闭其他菜单
            if (quickActionsMenu) quickActionsMenu.classList.add('hidden');
        });
    }
    
    // 点击外部关闭菜单
    document.addEventListener('click', function() {
        if (quickActionsMenu) quickActionsMenu.classList.add('hidden');
        if (userMenu) userMenu.classList.add('hidden');
    });
}

// 设置全屏切换
function setupFullscreenToggle() {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        });
    }
}

// 退出登录
async function logout() {
    if (typeof authManager !== 'undefined' && authManager) {
        await authManager.logout();
    }
}
</script>
