<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OA 系统</title>
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="pages/dashboard/style.css"> <!-- 复用部分样式 -->
    <script src="scripts/global.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
    <div id="toast-notification"></div>
    <div class="dashboard-wrapper">
        <header class="main-header">
            <h1>OA 系统</h1>
            <button id="hamburger-btn" class="hamburger-btn" aria-label="切换菜单">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div id="nav-menu" class="nav-menu">
                <nav class="main-nav">
                    <a href="pages/dashboard/index.html" class="nav-link active" data-target="pages/dashboard/index.html">仪表盘</a>
                    <a href="pages/scheduling/index.html" class="nav-link" data-target="pages/scheduling/index.html">排班管理</a>
                    <a href="pages/knowledge-base/index.html" class="nav-link" data-target="pages/knowledge-base/index.html">知识库</a>
                    <a href="pages/operations/index.html" class="nav-link" data-target="pages/operations/index.html">运营事务</a>
                    <a href="pages/teams/index.html" class="nav-link" data-target="pages/teams/index.html">团队管理</a>
                </nav>
                <div class="user-menu">
                    <a href="#" id="user-profile-link" class="user-profile-link">正在加载...</a>
                    <button id="logout-button" class="btn-logout">登出</button>
                </div>
            </div>
        </header>

        <main class="content-host">
            <iframe id="content-frame" src="pages/dashboard/index.html" frameborder="0" width="100%" height="100%"></iframe>
        </main>

        <footer class="dashboard-footer">
            <p>&copy; 2025 OA 系统. All Rights Reserved.</p>
        </footer>
    </div>

    <script src="scripts/main.js" defer></script>
    
    <!-- 新增: iframe与父窗口通信支持代码 -->
    <script>
        // 创建全局对象存储iframe通信状态
        window.iframeStates = {};
        
        // 监听来自iframe的消息
        window.addEventListener('message', function(event) {
            // 确保消息来源是安全的
            try {
                const iframe = document.getElementById('content-frame');
                if (iframe && iframe.contentWindow === event.source) {
                    const { type, data } = event.data;
                    
                    // 根据消息类型处理不同的事件
                    if (type === 'schedule-event') {
                        console.log('父窗口接收到iframe事件:', type, data);
                        
                        // 如果已加载了handleIframeScheduleEvent函数，则调用它
                        if (typeof handleIframeScheduleEvent === 'function') {
                            handleIframeScheduleEvent(data);
                        } else {
                            // 否则存储事件数据，等待函数加载完成
                            window.iframeStates.pendingEvent = { type, data };
                        }
                    }
                }
            } catch (error) {
                console.error('处理iframe消息时出错:', error);
            }
        });
        
        // 检查iframe是否已加载
        document.addEventListener('DOMContentLoaded', function() {
            const iframe = document.getElementById('content-frame');
            
            // 监听iframe加载完成事件
            iframe.addEventListener('load', function() {
                console.log('iframe已加载完成');
                
                // 如果存在待处理的事件，并且函数已加载，则处理它
                if (window.iframeStates.pendingEvent && typeof handleIframeScheduleEvent === 'function') {
                    handleIframeScheduleEvent(window.iframeStates.pendingEvent.data);
                    window.iframeStates.pendingEvent = null;
                }
                
                // 创建全局拖动状态对象
                if (!window.dragStateHandler) {
                    window.dragStateHandler = {
                        dragState: {
                            isDragging: false,
                            isResizing: false,
                            currentItem: null,
                            initialX: 0,
                            initialY: 0,
                            initialLeft: 0,
                            initialWidth: 0,
                            resizeDirection: null,
                            elementId: null,
                            iframeElement: iframe
                        },
                        getState() {
                            return this.dragState;
                        },
                        setState(newState) {
                            this.dragState = { ...this.dragState, ...newState };
                        },
                        resetState() {
                            this.dragState = {
                                isDragging: false,
                                isResizing: false,
                                currentItem: null,
                                initialX: 0,
                                initialY: 0,
                                initialLeft: 0,
                                initialWidth: 0,
                                resizeDirection: null,
                                elementId: null,
                                iframeElement: iframe
                            };
                        }
                    };
                }
            });
        });
    </script>
</body>
</html> 