<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐厅排班可视化</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f7f6;
            color: #333;
        }
        .main-container {
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h1 { text-align: center; margin-bottom: 30px; }
        h2 { margin: 30px 0 15px; font-size: 1.5em; }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        .legend-color-box {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
        }
        .day-block {
            margin-bottom: 40px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .timeline-area { overflow-x: auto; }
        .time-header-wrapper { display: flex; }
        .staff-label-placeholder, .staff-label {
            min-width: 150px;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .staff-label-placeholder {
            min-width: 150px;
            flex-shrink: 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ccc;
        }
        .add-staff-btn {
            width: 24px;
            height: 24px;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-staff-btn:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        .add-staff-btn svg {
            width: 16px;
            height: 16px;
            stroke: #3498db;
        }
        .staff-label-placeholder { background: none; }
        .time-header {
            flex-grow: 1;
            display: flex;
            border-bottom: 1px solid #ccc;
            background: #f9f9f9;
        }
        .time-hour-label {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 0.8em;
            color: #555;
            border-right: 1px solid #e0e0e0;
            min-width: 50px;
            cursor: pointer;
            user-select: none;
        }
        .time-hour-label:first-child { text-align: left; padding-left: 0; }
        .time-hour-label:last-child { border-right: none; text-align: right; padding-right: 0; }
        .time-hour-label:hover { background: rgba(231,76,60,0.1); }
        .time-hour-label.peak-time {
            background: rgba(231,76,60,0.2);
            color: #e74c3c;
            font-weight: bold;
        }
        .time-hour-label.peak-time::after {
            content: '⚡';
            position: absolute;
            top: -2px;
            right: 2px;
            font-size: 10px;
            color: #e74c3c;
        }
        .staff-track-row {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            min-height: 50px;
        }
        .staff-track-row:last-child { border-bottom: none; }
        .staff-label {
            padding: 10px 5px;
            font-size: 0.9em;
            font-weight: bold;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            line-height: 1.3;
            cursor: context-menu;
        }
        .staff-label small {
            font-weight: normal;
            font-size: 0.8em;
            color: #555;
            display: block;
        }
        .staff-label:hover { background: #f0f0f0; }
        .shift-timeline-bar {
            flex-grow: 1;
            height: 40px;
            position: relative;
            background: #fff linear-gradient(to right, #e0e0e0 1px, transparent 1px) 0/calc(100%/18) 100%;
        }
        .peak-time-background {
            position: absolute;
            top: 0;
            bottom: 0;
            background: rgba(231,76,60,0.1);
            pointer-events: none;
            z-index: 0;
        }
        .shift-segment {
            position: absolute;
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            opacity: 0.9;
            border: 1px solid rgba(0,0,0,0.2);
            cursor: move;
            user-select: none;
            z-index: 1;
        }
        .shift-segment::before, .shift-segment::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            background: rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .shift-segment::before { left: 0; cursor: w-resize; }
        .shift-segment::after { right: 0; cursor: e-resize; }
        .shift-segment:hover::before, .shift-segment:hover::after {
            opacity: 1;
            background: rgba(0,0,0,0.2);
        }
        .shift-segment.dragging { opacity: 0.7; z-index: 1000; }
        .shift-segment.rest {
            background: #bdc3c7 !important;
            color: #333;
            border: 1px dashed #7f8c8d;
            z-index: 5;
        }
        .front-office { background: #3498db; }
        .back-kitchen { background: #e67e22; }
        .dishwasher { background: #2ecc71; }
        .part-time { opacity: 0.5; }
        .note {
            padding: 10px;
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .context-menu {
            display: none;
            position: absolute;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 4px;
            z-index: 1000;
            min-width: 160px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            color: #333;
            transition: all 0.2s;
        }
        .context-menu-item:hover { background: #f5f5f5; }
        .context-menu-item svg { margin-right: 8px; width: 16px; height: 16px; }
        .context-menu-item#deleteSegment, .context-menu-item#deleteStaff {
            color: #e74c3c;
        }
        .context-menu-item#deleteSegment:hover, .context-menu-item#deleteStaff:hover {
            background: #fee;
        }
        .context-menu-item#deleteSegment svg, .context-menu-item#deleteStaff svg {
            stroke: #e74c3c;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
            font-size: 16px;
        }
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .time-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            display: none;
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            align-items: center;
        }
        .toolbar button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .toolbar button:hover { background: #f0f0f0; }
        .toolbar button:disabled { opacity: 0.5; cursor: not-allowed; }
        .toolbar button svg { width: 16px; height: 16px; }
        .toolbar .separator { width: 1px; height: 24px; background: #ddd; }
        .shortcut-hint {
            font-size: 0.8em;
            color: #666;
            margin-left: 5px;
            padding: 2px 5px;
            background: #eee;
            border-radius: 3px;
        }
        .history-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            display: none;
        }
        .history-panel h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #666;
        }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            cursor: pointer;
        }
        .history-item:hover { background: #f5f5f5; }
        #confirmDialog, #addStaffModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #confirmDialog > div, #addStaffModal > div {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #confirmDialog .buttons, #addStaffModal .buttons { text-align: right; }
        #confirmDialog button, #addStaffModal button {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        #confirmDialog .cancel, #addStaffModal .cancel {
            border: 1px solid #ddd;
            background: #f5f5f5;
        }
        #confirmDialog .confirm, #addStaffModal .confirm {
            background: #3498db;
            color: #fff;
            border: none;
        }
        #addStaffModal label {
            display: block;
            margin-bottom: 5px;
        }
        #addStaffModal input, #addStaffModal select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>餐厅排班可视化</h1>
        <div class="toolbar">
            <button id="undoBtn" disabled title="撤销">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"></path>
                    <path d="M3 13c0-4.97 4.03-9 9-9a8.94 8.94 0 0 1 7.84 4.75"></path>
                </svg>
                撤销
                <span class="shortcut-hint">Ctrl+Z</span>
            </button>
            <button id="redoBtn" disabled title="重做">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 7v6h-6"></path>
                    <path d="M21 13c0-4.97-4.03-9-9-9a8.94 8.94 0 0 0-7.84 4.75"></path>
                </svg>
                重做
                <span class="shortcut-hint">Ctrl+Y</span>
            </button>
            <div class="separator"></div>
            <button id="copyDayBtn" title="复制当天排班">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                复制当天
            </button>
            <button id="pasteDayBtn" disabled title="粘贴到选中日期">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                </svg>
                粘贴
            </button>
            <div class="separator"></div>
            <button id="toggleHistoryBtn" title="显示操作历史">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                操作历史
            </button>
        </div>
        <div id="historyPanel" class="history-panel">
            <h3>操作历史</h3>
            <div id="historyList" class="history-list"></div>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-color-box front-office"></div> 前厅</div>
            <div class="legend-item"><div class="legend-color-box back-kitchen"></div> 后厨</div>
            <div class="legend-item"><div class="legend-color-box dishwasher"></div> 洗碗间</div>
            <div class="legend-item"><div class="legend-color-box" style="background: #bdc3c7;"></div> 休息</div>
            <div class="legend-item"><div class="legend-color-box" style="opacity:0.5; background: #3498db;"></div> 兼职</div>
        </div>
        <div id="schedule-container"></div>
    </div>
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="deleteSegment">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            删除时间条
        </div>
        <div class="context-menu-item" id="deleteStaff">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            删除成员
        </div>
        <div class="context-menu-item" id="addWorkSegment">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            添加工作
        </div>
        <div class="context-menu-item" id="addRestSegment">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18z"></path>
                <path d="M12 7v5l3 3"></path>
            </svg>
            添加休息
        </div>
        <div class="context-menu-item" id="addNewStaff">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
            </svg>
            添加成员
        </div>
        <div class="context-menu-item" id="savePng">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            保存为PNG
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>正在生成图片...</div>
    </div>
    <div id="confirmDialog">
        <div>
            <div id="confirmMessage"></div>
            <div class="buttons">
                <button class="cancel">取消</button>
                <button class="confirm">确定</button>
            </div>
        </div>
    </div>
    <div id="addStaffModal">
        <div>
            <h3>添加新成员</h3>
            <label>姓名：<input type="text" id="newStaffName"></label>
            <label>职位：
                <select id="newStaffRole">
                    <option value="front-office">前厅</option>
                    <option value="back-kitchen">后厨</option>
                    <option value="dishwasher">洗碗间</option>
                </select>
            </label>
            <label>类型：
                <select id="newStaffType">
                    <option value="full-time">全职</option>
                    <option value="part-time">兼职</option>
                </select>
            </label>
            <div class="buttons">
                <button class="cancel">取消</button>
                <button class="confirm">确定</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { supabase } from '../../lib/supabaseClient.js';

        const config = {
            timelineStartHour: 9,
            timelineEndHourNextDay: 2,
            totalHours: 17,
            gridCount: 18,
            defaultPeakHours: [11, 12, 13, 18, 19, 20]
        };
        const state = {
            staffData: new Map(),
            allStaff: [],
            peakHours: new Set(config.defaultPeakHours),
            history: { undoStack: [], redoStack: [], maxSize: 50 },
            copiedSchedule: null,
            current: { segment: null, timeline: null, staffRow: null, dayBlock: null, clickX: 0 }
        };

        const dom = {
            container: document.getElementById('schedule-container'),
            contextMenu: document.getElementById('contextMenu'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            confirmDialog: document.getElementById('confirmDialog'),
            addStaffModal: document.getElementById('addStaffModal'),
            historyPanel: document.getElementById('historyPanel'),
            historyList: document.getElementById('historyList')
        };

        const roleMap = {
            '前厅': 'front-office',
            '后厨': 'back-kitchen',
            '洗碗间': 'dishwasher'
        };
        const typeMap = { '全职': 'full-time', '兼职': 'part-time' };

        async function loadStaffData() {
            try {
                const { data, error } = await supabase.from('schedule_view').select('*').order('id');
                if (error) throw error;

                const schedulesByDay = Object.fromEntries(['周一', '周二', '周三', '周四', '周五', '周六', '周日'].map(day => [day, []]));
                data.forEach(record => {
                    const staffKey = `${record.role}_${record.name}`;
                    schedulesByDay[record.day_name].push({
                        staff: staffKey,
                        is_resting: record.is_resting,
                        note: record.note,
                        segments: record.segments || []
                    });

                    if (!state.staffData.has(staffKey)) {
                        state.staffData.set(staffKey, {
                            name: record.name,
                            role: record.role,
                            type: record.employment_type,
                            role_text: `${record.role}${record.employment_type}`,
                            role_class: `${roleMap[record.role]} ${typeMap[record.employment_type]}`
                        });
                        state.allStaff.push({ id: staffKey, name: record.name, role: record.role, type: record.employment_type });
                    }
                });

                await initializePage(schedulesByDay);
                state.history.undoStack.push(getCurrentState());
            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载数据失败，请刷新重试');
            }
        }

        function createTimeHeader() {
            return `
                <div class="time-header-wrapper">
                    <div class="staff-label-placeholder">
                        <div class="add-staff-btn" title="添加成员">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                                <line x1="12" y1="11" x2="12" y2="17"></line>
                                <line x1="9" y1="14" x2="15" y2="14"></line>
                            </svg>
                        </div>
                    </div>
                    <div class="time-header">
                        ${Array.from({length: config.totalHours + 1}, (_, i) => {
                            const hour = (config.timelineStartHour + i) % 24;
                            return `<div class="time-hour-label" data-hour="${hour}">${String(hour).padStart(2, '0')}:00</div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        async function initializePage(schedulesByDay) {
            dom.container.innerHTML = '';
            for (const [dayName, staffList] of Object.entries(schedulesByDay)) {
                const dayBlock = document.createElement('div');
                dayBlock.className = 'day-block';
                dayBlock.innerHTML = `
                    <h2>${dayName}</h2>
                    <div class="timeline-area">${createTimeHeader()}</div>`;
                
                const timelineArea = dayBlock.querySelector('.timeline-area');
                staffList.forEach(staffInfo => {
                    if (staffInfo.is_resting) return;
                    const staff = state.staffData.get(staffInfo.staff);
                    const [roleClass, typeClass] = staff.role_class.split(' ');
                    const segments = staffInfo.segments.map(segment => `
                        <div class="shift-segment ${segment.type} ${roleClass} ${typeClass}"
                             style="left:${segment.start_percent}%;width:${segment.width_percent}%">
                            ${segment.type === 'work' ? '工作' : '休息'}
                        </div>`).join('');
                    const note = staffInfo.note ? `<div class="note">${staffInfo.note}</div>` : '';
                    timelineArea.insertAdjacentHTML('beforeend', `
                        <div class="staff-track-row">
                            <div class="staff-label">${staff.name} <small>${staff.role_text}</small></div>
                            <div class="shift-timeline-bar">
                                <div class="timeline-background"></div>
                                ${segments}${note}
                            </div>
                        </div>`);
                });

                dom.container.appendChild(dayBlock);
                updateDayTitle(dayBlock);
                updatePeakTimeVisuals();
            }

            initializeDragAndResize();
            setupEventListeners();
        }

        function updatePeakTimeVisuals() {
            document.querySelectorAll('.time-hour-label').forEach(label => {
                label.classList.toggle('peak-time', state.peakHours.has(+label.dataset.hour));
            });
            document.querySelectorAll('.shift-timeline-bar').forEach(timeline => {
                timeline.querySelectorAll('.peak-time-background').forEach(el => el.remove());
                state.peakHours.forEach(hour => {
                    const displayHour = hour < 9 ? hour + 24 : hour;
                    const position = ((displayHour - 9) / config.gridCount) * 100;
                    timeline.insertAdjacentHTML('beforeend', `
                        <div class="peak-time-background" style="left:${position}%;width:${100/config.gridCount}%"></div>`);
                });
            });
        }

        function initializeDragAndResize() {
            let dragState = { isDragging: false, isResizingLeft: false, isResizingRight: false, segment: null, startX: 0, startLeft: 0, startWidth: 0, tooltip: null, wasDragged: false };
            
            function handleMouseDown(e) {
                const segment = e.target.closest('.shift-segment');
                if (!segment) return;
                dragState.wasDragged = false;
                const rect = segment.getBoundingClientRect();
                dragState.isResizingRight = e.clientX > rect.right - 8;
                dragState.isResizingLeft = e.clientX < rect.left + 8;
                dragState.isDragging = !dragState.isResizingRight && !dragState.isResizingLeft;
                dragState.segment = segment;
                dragState.startX = e.clientX;
                dragState.startLeft = parseFloat(segment.style.left);
                dragState.startWidth = parseFloat(segment.style.width);
                segment.classList.add('dragging');
            }

            document.querySelectorAll('.shift-segment').forEach(segment => {
                segment.removeEventListener('mousedown', handleMouseDown);
                segment.addEventListener('mousedown', handleMouseDown);
                segment.addEventListener('mousemove', e => {
                    const rect = segment.getBoundingClientRect();
                    segment.style.cursor = e.clientX > rect.right - 8 || e.clientX < rect.left + 8 ? 'ew-resize' : 'move';
                });
            });

            document.addEventListener('mousemove', e => {
                if (!dragState.isDragging && !dragState.isResizingLeft && !dragState.isResizingRight) return;
                dragState.wasDragged = true;
                const timeline = dragState.segment.closest('.shift-timeline-bar');
                const deltaX = ((e.clientX - dragState.startX) / timeline.getBoundingClientRect().width) * 100;

                if (dragState.isDragging) {
                    let newLeft = snapToGrid(Math.max(0, Math.min(100 - dragState.startWidth, dragState.startLeft + deltaX)));
                    dragState.segment.style.left = `${newLeft}%`;
                } else if (dragState.isResizingLeft) {
                    let newLeft = snapToGrid(dragState.startLeft + deltaX);
                    let newWidth = dragState.startWidth + (dragState.startLeft - newLeft);
                    if (newLeft >= 0 && newWidth >= 100/config.gridCount && newLeft + newWidth <= 100) {
                        dragState.segment.style.left = `${newLeft}%`;
                        dragState.segment.style.width = `${newWidth}%`;
                    }
                } else if (dragState.isResizingRight) {
                    let newWidth = snapToGrid(Math.max(100/config.gridCount, Math.min(100 - dragState.startLeft, dragState.startWidth + deltaX)));
                    dragState.segment.style.width = `${newWidth}%`;
                }

                updateTimeTooltip(dragState, e);
            });

            document.addEventListener('mouseup', async () => {
                if (!dragState.segment) return;
                dragState.segment.classList.remove('dragging');
                if (dragState.wasDragged) {
                    const staffRow = dragState.segment.closest('.staff-track-row');
                    const segments = Array.from(staffRow.querySelectorAll('.shift-segment')).map(segment => ({
                        type: segment.classList.contains('rest') ? 'rest' : 'work',
                        start_percent: parseFloat(segment.style.left),
                        width_percent: parseFloat(segment.style.width)
                    }));
                    await updateSchedule(staffRow, segments);
                    saveState();
                }
                dragState = { ...dragState, isDragging: false, isResizingLeft: false, isResizingRight: false, segment: null };
                if (dragState.tooltip) dragState.tooltip.style.display = 'none';
            });

            function snapToGrid(percent) {
                return Math.round(percent / (100/config.gridCount)) * (100/config.gridCount);
            }

            function updateTimeTooltip(dragState, e) {
                if (!dragState.tooltip) {
                    dragState.tooltip = document.createElement('div');
                    dragState.tooltip.className = 'time-tooltip';
                    document.body.appendChild(dragState.tooltip);
                }
                const left = parseFloat(dragState.segment.style.left);
                const width = parseFloat(dragState.segment.style.width);
                dragState.tooltip.textContent = `${percentToTime(left)} - ${percentToTime(left + width)}`;
                dragState.tooltip.style.display = 'block';
                dragState.tooltip.style.left = `${e.pageX + 10}px`;
                dragState.tooltip.style.top = `${e.pageY - 30}px`;
            }

            function percentToTime(percent) {
                const totalMinutes = percent * (config.gridCount * 60) / 100;
                const hours = Math.floor(totalMinutes / 60) + config.timelineStartHour;
                const minutes = Math.floor(totalMinutes % 60);
                const displayHours = hours >= 24 ? hours - 24 : hours;
                return `${String(displayHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
        }

        async function updateSchedule(staffRow, segments) {
            const staffName = staffRow.querySelector('.staff-label').textContent.split(' ')[0];
            const dayName = staffRow.closest('.day-block').querySelector('h2').textContent.split(/[\s\(]/)[0];
            try {
                const { error } = await supabase.rpc('insert_schedule', {
                    p_name: staffName,
                    p_day_name: dayName,
                    p_is_resting: false,
                    p_segments: segments
                });
                if (error) throw error;
            } catch (error) {
                console.error('更新排班失败:', error);
                alert(`更新排班失败: ${error.message}`);
            }
        }

        function setupEventListeners() {
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                state.current.clickX = e.clientX;
                state.current.dayBlock = e.target.closest('.day-block');
                state.current.staffRow = null;
                const segment = e.target.closest('.shift-segment');
                const timeline = e.target.closest('.shift-timeline-bar');
                const staffLabel = e.target.closest('.staff-label');
                const mainContainer = e.target.closest('.main-container');

                Array.from(dom.contextMenu.children).forEach(item => item.style.display = 'none');
                if (staffLabel) {
                    state.current.staffRow = staffLabel.closest('.staff-track-row');
                    ['deleteStaff', 'addNewStaff'].forEach(id => document.getElementById(id).style.display = 'flex');
                } else if (segment) {
                    state.current.segment = segment;
                    state.current.timeline = segment.closest('.shift-timeline-bar');
                    document.getElementById('deleteSegment').style.display = 'flex';
                } else if (timeline) {
                    state.current.timeline = timeline;
                    ['addWorkSegment', 'addRestSegment'].forEach(id => document.getElementById(id).style.display = 'flex');
                } else if (mainContainer) {
                    document.getElementById('savePng').style.display = 'flex';
                }

                if (segment || timeline || staffLabel || mainContainer) {
                    dom.contextMenu.style.display = 'block';
                    dom.contextMenu.style.left = `${e.pageX}px`;
                    dom.contextMenu.style.top = `${e.pageY}px`;
                }
            });

            document.addEventListener('click', () => {
                dom.contextMenu.style.display = 'none';
                state.current.segment = state.current.timeline = null;
            });

            document.getElementById('deleteSegment').addEventListener('click', () => {
                if (!state.current.segment) return;
                showConfirm('确定删除该时间条？', async confirmed => {
                    if (confirmed) {
                        saveState();
                        const staffRow = state.current.segment.closest('.staff-track-row');
                        state.current.segment.remove();
                        const segments = Array.from(staffRow.querySelectorAll('.shift-segment')).map(segment => ({
                            type: segment.classList.contains('rest') ? 'rest' : 'work',
                            start_percent: parseFloat(segment.style.left),
                            width_percent: parseFloat(segment.style.width)
                        }));
                        await updateSchedule(staffRow, segments);
                        saveState();
                    }
                    dom.contextMenu.style.display = 'none';
                    state.current.segment = null;
                });
            });

            document.getElementById('deleteStaff').addEventListener('click', () => {
                if (!state.current.staffRow) return;
                showConfirm('确定删除该成员？', async confirmed => {
                    if (confirmed) {
                        saveState();
                        const staffLabel = state.current.staffRow.querySelector('.staff-label');
                        const staffName = staffLabel.textContent.split(' ')[0];
                        const staffInfo = staffLabel.textContent;
                        
                        // 获取完整的staff信息
                        let staffRole = '';
                        if (staffInfo.includes('前厅')) staffRole = '前厅';
                        else if (staffInfo.includes('后厨')) staffRole = '后厨';
                        else if (staffInfo.includes('洗碗间')) staffRole = '洗碗间';
                        
                        const staffType = staffInfo.includes('兼职') ? '兼职' : '全职';
                        const dayName = state.current.staffRow.closest('.day-block').querySelector('h2').textContent.split(' ')[0];
                        
                        try {
                            const { error } = await supabase.from('staff_schedules').delete().eq('name', staffName).eq('day_name', dayName);
                            if (error) throw error;
                            
                            // 从状态中删除staff
                            const staffKey = `${staffRole}_${staffName}`;
                            state.staffData.delete(staffKey);
                            state.allStaff = state.allStaff.filter(s => s.name !== staffName);
                            
                            // 更新UI
                            state.current.staffRow.remove();
                            updateDayTitle(state.current.staffRow.closest('.day-block'));
                            saveState();
                        } catch (error) {
                            console.error('删除成员失败:', error);
                            alert('删除成员失败，请重试');
                        }
                    }
                    dom.contextMenu.style.display = 'none';
                    state.current.staffRow = null;
                });
            });

            document.getElementById('addWorkSegment').addEventListener('click', () => addSegment('work'));
            document.getElementById('addRestSegment').addEventListener('click', () => addSegment('rest'));

            async function addSegment(type) {
                if (!state.current.timeline) return;
                
                const timelineRect = state.current.timeline.getBoundingClientRect();
                const position = ((state.current.clickX - timelineRect.left) / timelineRect.width) * 100;
                const snappedPosition = Math.round(position / (100/config.gridCount)) * (100/config.gridCount);
                
                const staffRow = state.current.timeline.closest('.staff-track-row');
                const staffLabel = staffRow.querySelector('.staff-label');
                const staffName = staffLabel.textContent.split(' ')[0];
                const staffInfo = staffLabel.textContent;
                
                // 获取员工角色和类型
                let roleClass = '';
                if (staffInfo.includes('前厅')) roleClass = 'front-office';
                else if (staffInfo.includes('后厨')) roleClass = 'back-kitchen';
                else if (staffInfo.includes('洗碗间')) roleClass = 'dishwasher';
                
                const typeClass = staffInfo.includes('兼职') ? 'part-time' : 'full-time';
                
                // 创建新的时间段元素
                const newSegment = document.createElement('div');
                newSegment.className = `shift-segment ${type}`;
                if (type === 'work') {
                    newSegment.className += ` ${roleClass} ${typeClass}`;
                }
                newSegment.style.left = `${snappedPosition}%`;
                newSegment.style.width = `${100/config.gridCount}%`;
                newSegment.textContent = type === 'work' ? '工作' : '休息';
                
                state.current.timeline.appendChild(newSegment);
                
                // 更新数据库
                const dayName = staffRow.closest('.day-block').querySelector('h2').textContent.split(/[\s\(]/)[0];
                const segments = Array.from(staffRow.querySelectorAll('.shift-segment')).map(segment => ({
                    type: segment.classList.contains('rest') ? 'rest' : 'work',
                    start_percent: parseFloat(segment.style.left),
                    width_percent: parseFloat(segment.style.width)
                }));
                
                try {
                    const { error } = await supabase.rpc('insert_schedule', {
                        p_name: staffName,
                        p_day_name: dayName,
                        p_is_resting: false,
                        p_segments: segments
                    });
                    
                    if (error) throw error;
                    
                    // 重新初始化拖拽功能
                    initializeDragAndResize();
                    // 保存状态
                    saveState();
                    
                } catch (error) {
                    console.error('更新排班失败:', error);
                    alert('更新排班失败，请重试');
                    // 如果失败，移除新添加的时间段
                    newSegment.remove();
                }
                
                dom.contextMenu.style.display = 'none';
                state.current.timeline = null;
            }

            document.getElementById('addNewStaff').addEventListener('click', () => {
                dom.addStaffModal.style.display = 'block';
                dom.contextMenu.style.display = 'none';
            });

            dom.addStaffModal.querySelector('.cancel').addEventListener('click', () => dom.addStaffModal.style.display = 'none');
            dom.addStaffModal.querySelector('.confirm').addEventListener('click', async () => {
                const name = document.getElementById('newStaffName').value.trim();
                const role = document.getElementById('newStaffRole').value;
                const type = document.getElementById('newStaffType').value;
                if (!name) return alert('请输入姓名');
                if (!state.current.dayBlock) return alert('请选择日期');
                
                const dayName = state.current.dayBlock.querySelector('h2').textContent.split(' ')[0];
                const roleText = { 'front-office': '前厅', 'back-kitchen': '后厨', 'dishwasher': '洗碗间' }[role];
                const typeText = type === 'full-time' ? '全职' : '兼职';
                try {
                    const { error } = await supabase.from('staff_schedules').insert([{
                        name, role: roleText, employment_type: typeText, day_name: dayName, is_resting: false, segments: []
                    }]);
                    if (error) throw error;

                    const staffKey = `${roleText}_${name}`;
                    state.staffData.set(staffKey, {
                        name, role: roleText, type: typeText, role_text: `${roleText}${typeText}`, role_class: `${roleMap[roleText]} ${typeMap[typeText]}`
                    });
                    state.allStaff.push({ id: staffKey, name, role: roleText, type: typeText });

                    state.current.dayBlock.querySelector('.timeline-area').insertAdjacentHTML('beforeend', `
                        <div class="staff-track-row">
                            <div class="staff-label">${name} <small>${roleText}${typeText}</small></div>
                            <div class="shift-timeline-bar"><div class="timeline-background"></div></div>
                        </div>`);
                    initializeDragAndResize();
                    updateDayTitle(state.current.dayBlock);
                    dom.addStaffModal.style.display = 'none';
                    document.getElementById('newStaffName').value = '';
                    state.current.dayBlock = null;
                    saveState();
                } catch (error) {
                    console.error('添加成员失败:', error);
                    alert('添加成员失败，请重试');
                }
            });

            document.getElementById('savePng').addEventListener('click', async () => {
                dom.contextMenu.style.display = 'none';
                dom.loadingOverlay.style.display = 'flex';
                try {
                    if (!window.html2canvas) await loadScript('https://html2canvas.hertzen.com/dist/html2canvas.min.js');
                    const canvas = await html2canvas(document.querySelector('.main-container'), { scale: 2, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `排班表_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    console.error('保存图片失败:', error);
                    alert('保存图片失败');
                } finally {
                    dom.loadingOverlay.style.display = 'none';
                }
            });

            document.querySelectorAll('.time-hour-label').forEach(label => {
                label.addEventListener('click', () => {
                    const hour = +label.dataset.hour;
                    state.peakHours.has(hour) ? state.peakHours.delete(hour) : state.peakHours.add(hour);
                    updatePeakTimeVisuals();
                    saveState();
                });
            });

            document.getElementById('undoBtn').addEventListener('click', () => state.history.undo());
            document.getElementById('redoBtn').addEventListener('click', () => state.history.redo());
            document.getElementById('toggleHistoryBtn').addEventListener('click', () => {
                dom.historyPanel.style.display = dom.historyPanel.style.display === 'none' ? 'block' : 'none';
            });

            document.getElementById('copyDayBtn').addEventListener('click', () => {
                const selectedDay = document.querySelector('.day-block.selected');
                if (!selectedDay) return alert('请选择要复制的日期');
                state.copiedSchedule = {
                    schedules: Array.from(selectedDay.querySelectorAll('.staff-track-row')).map(row => ({
                        name: row.querySelector('.staff-label').textContent.split(' ')[0],
                        segments: Array.from(row.querySelectorAll('.shift-segment')).map(segment => ({
                            type: segment.classList.contains('rest') ? 'rest' : 'work',
                            left: parseFloat(segment.style.left),
                            width: parseFloat(segment.style.width)
                        }))
                    })),
                    peakHours: Array.from(state.peakHours)
                };
                document.getElementById('pasteDayBtn').disabled = false;
            });

            document.getElementById('pasteDayBtn').addEventListener('click', () => {
                if (!state.copiedSchedule) return alert('请先复制排班');
                const selectedDay = document.querySelector('.day-block.selected');
                if (!selectedDay) return alert('请选择目标日期');
                saveState();
                state.copiedSchedule.schedules.forEach(schedule => {
                    const staffRow = Array.from(selectedDay.querySelectorAll('.staff-track-row'))
                        .find(row => row.querySelector('.staff-label').textContent.split(' ')[0] === schedule.name);
                    if (staffRow) {
                        const timeline = staffRow.querySelector('.shift-timeline-bar');
                        timeline.querySelectorAll('.shift-segment').forEach(segment => segment.remove());
                        schedule.segments.forEach(segment => {
                            timeline.insertAdjacentHTML('beforeend', `
                                <div class="shift-segment ${segment.type}" style="left:${segment.left}%;width:${segment.width}%">
                                    ${segment.type === 'work' ? '工作' : '休息'}
                                </div>`);
                        });
                    }
                });
                initializeDragAndResize();
                saveState();
            });

            document.querySelectorAll('.day-block').forEach(block => {
                block.addEventListener('click', e => {
                    if (!e.target.closest('.shift-segment') && !e.target.closest('.staff-label')) {
                        document.querySelectorAll('.day-block').forEach(b => b.classList.remove('selected'));
                        block.classList.add('selected');
                    }
                });
            });

            document.addEventListener('keydown', e => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    switch (e.key.toLowerCase()) {
                        case 'z': e.shiftKey ? state.history.redo() : state.history.undo(); break;
                        case 'y': state.history.redo(); break;
                        case 'c': document.querySelector('.day-block.selected') && document.getElementById('copyDayBtn').click(); break;
                        case 'v': !document.getElementById('pasteDayBtn').disabled && document.getElementById('pasteDayBtn').click(); break;
                    }
                }
            });

            // 添加成员按钮点击事件
            document.querySelectorAll('.add-staff-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    state.current.dayBlock = e.target.closest('.day-block');
                    dom.addStaffModal.style.display = 'block';
                });
            });
        }

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            dom.confirmDialog.style.display = 'block';
            const confirm = () => {
                dom.confirmDialog.style.display = 'none';
                callback(true);
                dom.confirmDialog.querySelector('.confirm').removeEventListener('click', confirm);
                dom.confirmDialog.querySelector('.cancel').removeEventListener('click', cancel);
            };
            const cancel = () => {
                dom.confirmDialog.style.display = 'none';
                callback(false);
                dom.confirmDialog.querySelector('.confirm').removeEventListener('click', confirm);
                dom.confirmDialog.querySelector('.cancel').removeEventListener('click', cancel);
            };
            dom.confirmDialog.querySelector('.confirm').addEventListener('click', confirm);
            dom.confirmDialog.querySelector('.cancel').addEventListener('click', cancel);
        }

        function updateDayTitle(dayBlock) {
            if (!dayBlock) return;
            const presentStaff = Array.from(dayBlock.querySelectorAll('.staff-label')).map(label => label.textContent.split(' ')[0]);
            const restingStaff = state.allStaff.filter(staff => !presentStaff.includes(staff.name)).map(staff => staff.name);
            const dayName = dayBlock.querySelector('h2').textContent.split(' ')[0];
            dayBlock.querySelector('h2').textContent = dayName + (restingStaff.length ? ` (${restingStaff.join('、')}休息)` : '');
        }

        function getCurrentState() {
            return {
                schedules: Array.from(document.querySelectorAll('.day-block')).map(dayBlock => ({
                    dayName: dayBlock.querySelector('h2').textContent.split(' ')[0],
                    schedules: Array.from(dayBlock.querySelectorAll('.staff-track-row')).map(row => ({
                        name: row.querySelector('.staff-label').textContent.split(' ')[0],
                        segments: Array.from(row.querySelectorAll('.shift-segment')).map(segment => ({
                            type: segment.classList.contains('rest') ? 'rest' : 'work',
                            left: parseFloat(segment.style.left),
                            width: parseFloat(segment.style.width)
                        }))
                    }))
                })),
                peakHours: Array.from(state.peakHours)
            };
        }

        function applyState(state) {
            state.peakHours.forEach(hour => state.peakHours.add(hour));
            updatePeakTimeVisuals();
            state.schedules.forEach(dayState => {
                const dayBlock = Array.from(document.querySelectorAll('.day-block'))
                    .find(block => block.querySelector('h2').textContent.split(' ')[0] === dayState.dayName);
                if (dayBlock) {
                    dayState.schedules.forEach(schedule => {
                        const staffRow = Array.from(dayBlock.querySelectorAll('.staff-track-row'))
                            .find(row => row.querySelector('.staff-label').textContent.split(' ')[0] === schedule.name);
                        if (staffRow) {
                            const timeline = staffRow.querySelector('.shift-timeline-bar');
                            timeline.querySelectorAll('.shift-segment').forEach(segment => segment.remove());
                            schedule.segments.forEach(segment => {
                                timeline.insertAdjacentHTML('beforeend', `
                                    <div class="shift-segment ${segment.type}" style="left:${segment.left}%;width:${segment.width}%">
                                        ${segment.type === 'work' ? '工作' : '休息'}
                                    </div>`);
                            });
                        }
                    });
                    updateDayTitle(dayBlock);
                }
            });
            initializeDragAndResize();
        }

        state.history.push = function(state) {
            this.undoStack.push(JSON.stringify(state));
            if (this.undoStack.length > this.maxSize) this.undoStack.shift();
            this.redoStack = [];
            this.updateButtons();
            this.updateHistoryPanel();
        };

        state.history.undo = function() {
            if (this.undoStack.length) {
                this.redoStack.push(JSON.stringify(getCurrentState()));
                applyState(JSON.parse(this.undoStack.pop()));
                this.updateButtons();
                this.updateHistoryPanel();
            }
        };

        state.history.redo = function() {
            if (this.redoStack.length) {
                this.undoStack.push(JSON.stringify(getCurrentState()));
                applyState(JSON.parse(this.redoStack.pop()));
                this.updateButtons();
                this.updateHistoryPanel();
            }
        };

        state.history.updateButtons = function() {
            document.getElementById('undoBtn').disabled = !this.undoStack.length;
            document.getElementById('redoBtn').disabled = !this.redoStack.length;
        };

        state.history.updateHistoryPanel = function() {
            dom.historyList.innerHTML = this.undoStack.slice().reverse().map((_, i) => `
                <div class="history-item" data-index="${this.undoStack.length - i - 1}">
                    操作 ${this.undoStack.length - i}
                </div>`).join('');
            dom.historyList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const steps = this.undoStack.length - item.dataset.index - 1;
                    for (let i = 0; i <= steps; i++) this.undo();
                });
            });
        };

        function saveState() {
            state.history.push(getCurrentState());
            clearTimeout(state.saveTimeout);
            state.saveTimeout = setTimeout(async () => {
                try {
                    const promises = Array.from(document.querySelectorAll('.day-block')).flatMap(dayBlock => {
                        const dayName = dayBlock.querySelector('h2').textContent.split(/[\s\(]/)[0];
                        const schedules = Array.from(dayBlock.querySelectorAll('.staff-track-row')).map(row => ({
                            name: row.querySelector('.staff-label').textContent.split(' ')[0],
                            segments: Array.from(row.querySelectorAll('.shift-segment')).map(segment => ({
                                type: segment.classList.contains('rest') ? 'rest' : 'work',
                                start_percent: parseFloat(segment.style.left),
                                width_percent: parseFloat(segment.style.width)
                            }))
                        }));
                        const restingMatch = dayBlock.querySelector('h2').textContent.match(/\((.*?)休息\)/);
                        const resting = restingMatch ? restingMatch[1].split('、').map(name => ({
                            name, segments: [], is_resting: true
                        })) : [];
                        return [...schedules.map(s => ({ ...s, is_resting: false })), ...resting].map(s => 
                            supabase.rpc('insert_schedule', {
                                p_name: s.name,
                                p_day_name: dayName,
                                p_is_resting: s.is_resting,
                                p_segments: s.segments
                            })
                        );
                    });
                    await Promise.all(promises);
                } catch (error) {
                    console.error('保存失败:', error);
                    alert(`保存失败: ${error.message}`);
                }
            }, 3000);
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        document.addEventListener('DOMContentLoaded', loadStaffData);
    </script>
</body>
</html>